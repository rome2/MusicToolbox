<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Music Toolbox</title>
    <link rel="preload" as="font" href="fonts/Bravura.woff2" crossorigin="anonymous" />
    <link rel="preload" as="font" href="fonts/BravuraText.woff2" crossorigin="anonymous" />
    <style>
      @font-face {
          font-family: 'scoreGlyphs';
          src: url('fonts/Bravura.eot');
          src: url('fonts/Bravura.eot?#iefix') format('embedded-opentype'),
               url('fonts/Bravura.woff2') format('woff2'),
               url('fonts/Bravura.woff') format('woff'),
               url('fonts/Bravura.ttf')  format('truetype'),
               url('fonts/Bravura.otf')  format('opentype'),
               url('fonts/Bravura.svg#Bravura') format('svg');
      }
      @font-face {
          font-family: 'scoreText';
          src: url('fonts/BravuraText.eot');
          src: url('fonts/BravuraText.eot?#iefix') format('embedded-opentype'),
               url('fonts/BravuraText.woff2') format('woff2'),
               url('fonts/BravuraText.woff') format('woff'),
               url('fonts/BravuraText.ttf')  format('truetype'),
               url('fonts/BravuraText.otf')  format('opentype'),
               url('fonts/BravuraText.svg#BravuraText') format('svg');
      }
      body {
        padding: 0;
        margin: 0;
        background: #EEEEEE;
      }
      canvas {
        background: white;
        display: block;
        margin: 100px auto;
        border: 1px;
        border-style: solid;
        border-color: #000000;
      }
    </style>
</head>
<body>
<div style="font-family: scoreGlyphs;">.</div>
<div style="font-family: scoreText;">.</div>
<canvas id="myCanvas" width="800" height="600"></canvas>

<script>

"use strict";

////////////////////////////////////////////////////////////////////////////////
// Get the mouse event cursor position for a canvas element.
//
// canvas: The canvas.
// e:      The mouse event parameter.
// Returns an object with the x and y coordinates.
//
function getCanvasCursorPosition(canvas, e) {

    var x;
    var y;

    // In modern browsers it's simple:
    if (e.pageX != undefined && e.pageY != undefined) {
      x = e.pageX;
      y = e.pageY;
    }
    else {
      // IE < 12 doesn't have pageXY in the event so calc it ourselves:
      x = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
      y = e.clientY + document.body.scrollTop  + document.documentElement.scrollTop;
    }

    // X and Y are now relative to the document. Move them to the canvas:
    x -= canvas.offsetLeft;
    y -= canvas.offsetTop;

    // Done:
    return {
      x: x,
      y: y
    };
}

////////////////////////////////////////////////////////////////////////////////
// Make sure that a canvas is High DPI aware. Sets up scaling as needed.
//
// Example:
//   var ctx = setupCanvas(document.querySelector('.my-canvas'));
//   ctx.lineWidth = 5;
//   ctx.beginPath();
//   ctx.moveTo(100, 100);
//   ctx.lineTo(200, 200);
//   ctx.stroke();
//
function setupCanvas(canvas) {

  // Get the device pixel ratio, falling back to 1:
  var dpr = window.devicePixelRatio || 1;

  // Get the size of the canvas in CSS pixels:
  var rect = canvas.getBoundingClientRect();

  // Give the canvas pixel dimensions of their CSS size * the device pixel ratio:
  canvas.width  = rect.width * dpr;
  canvas.height = rect.height * dpr;
  var ctx = canvas.getContext('2d');

  // Scale all drawing operations by the dpr, so you don't have to worry about the difference.
  ctx.scale(dpr, dpr);

  // This is the final context:
  return ctx;
}

////////////////////////////////////////////////////////////////////////////////
// Draw the stave lines.
//
// context:  The current drawing context. This has to be set to use the correct
//           colors for stroke before calling this function.
// x, y:     x and y position of the lowest stave line. This is the reference
//           for all glyphs.
// width:    Width of the system.
// textSize: Current text size of the context.
//
function drawStaveLines(context, x, y, width, textSize) {

  // All stave lines combined are "textSize" pixels high so the distance between
  // two stave lines is 1/4 of that:
  var lineHeight = textSize / 4;
  var i;

  // Draw the lines:
  context.beginPath();
  for (i = 0; i < 5; i++) {
    context.moveTo(x, y - (i * lineHeight));
    context.lineTo(x + width, y - (i * lineHeight));
  }
  context.stroke();
  context.closePath();
}

////////////////////////////////////////////////////////////////////////////////
// Draw a clef on the stave lines.
//
// context:  The current drawing context. This has to be set to use the correct
//           colors for stroke and fill. Please make sure that the score font is
//           loaded before calling this function.
// which:    Clef symbol to draw. Supported symbols are "G", "F", "C" and "N"
//           for neutral clef (percussion etc).
// trans:    By default all clefs are on the the lowest line. Use this value to
//           transpose the clef up or down in half tone steps. For the "G" clef
//           this would typically be 2, the "C" clef uses 4 and the "F" clef 6.
// octave:   Use the octave up/down versions of the clefs if possible. "G" and
//           "F" support +/- 2 octaves, "C" can only be transposed one octave
//           down and "N" doesn't support octaves at all.
// x, y:     x and y position of the lowest stave line. This is the reference
//           for all glyphs.
// textSize: Current text size of the context.
//
// Returns the width in pixels of the rendered clef.
//
// Remarks: See https://en.wikipedia.org/wiki/Clef
//
function drawClef(context, which, trans, octave, x, y, textSize) {
  var textString = "";

  // Extract glyph for the clef:
  if (which == "G") {
    if (octave == -2)
      textString ="\uE051";
    if (octave == -1)
      textString ="\uE052";
    else if (octave == 1)
      textString ="\uE053";
    else if (octave == 2)
      textString ="\uE053";
    else
      textString ="\uE050";
  } else if (which == "F") {
    if (octave == -2)
      textString ="\uE063";
    if (octave == -1)
      textString ="\uE064";
    else if (octave == 1)
      textString ="\uE065";
    else if (octave == 2)
      textString ="\uE066";
    else
      textString ="\uE062";
  } else if (which == "C") {
    if (octave == -1)
      textString ="\uE05D";
    else
      textString ="\uE05C";
  } else if (which == "N") {
    textString ="\uE069";
  }

  // All stave lines combined are "textSize" pixels high so one half tone is
  // 1/8 of that:
  var offset = (textSize * trans) / 8;

  // Draw the glyph:
  context.fillText(textString , x, y - offset);

  // Measure the width:
  return context.measureText(textString).width;
}

////////////////////////////////////////////////////////////////////////////////
// Draw the time signature on the stave lines.
//
// context:    The current drawing context. This has to be set to use correct
//             colors for stroke and fill. Please make sure that the score font
//             is loaded before calling this function.
// upper:      Upper part of the time signature.
// lower:      Lower part of the time signature.
// useSymbols: Use symbols instead of numbers. This only works for 4/4 and 2/2.
// x, y:       x and y position of the lowest stave line. This is the reference
//             for all glyphs.
// textSize:   Current text size of the context.
//
// Returns the width in pixels of the rendered clef.
//
// Remarks: See https://en.wikipedia.org/wiki/Time_signature
//
function drawTimeSignature(context, upper, lower, useSymbols, x, y, textSize) {

  // Use symbols instead of numbers?
  if (useSymbols && upper == lower && (upper == 2 || upper == 4)) {

    // Find symbol:
    var textString = "";
    if (upper == 4)
      textString = "\uE08A";
    else
      textString = "\uE08B";

    // Draw the text:
    context.fillText(textString , x, y - textSize / 2);

    // Measure the width:
    return context.measureText(textString).width;
  }

  // The unicode characters for the time signature (0-9):
  var chars = [ "\uE080", "\uE081", "\uE082", "\uE083", "\uE084",
                "\uE085", "\uE086", "\uE087", "\uE088", "\uE089" ];

  // Convert upper part to a string:
  var upperText = '';
  while (upper >= 0.5) {
    upperText = chars[upper % 10] + upperText;
    upper = Math.floor(upper / 10);
  }

  // Convert lower part to a string:
  var lowerText = '';
  while (lower >= 0.5) {
    lowerText = chars[lower % 10] + lowerText;
    lower = Math.floor(lower / 10);
  }

  // Measure texts:
  upperSize = context.measureText(upperText).width;
  lowerSize = context.measureText(lowerText).width;

  // Center text:
  var upperX = 0;
  var lowerX = 0;
  if (upperSize > lowerSize)
    lowerX = (upperSize - lowerSize) / 2;
  else
    upperX = (lowerSize - upperSize) / 2;

  // Draw the glyphs:
  context.fillText(upperText, x + upperX, y - (textSize * 3) / 4);
  context.fillText(lowerText, x + lowerX, y - textSize / 4);

  // Return text width:
  if (upperSize > lowerSize)
    return upperSize;
  return lowerSize;
}

// https://en.wikipedia.org/wiki/Key_signature
function drawKey(context, key, clef, x, y, textSize) {

  // The C key has no sharps or flats:
  if (key == 0)
    return 0;

  // Get glyph to draw and calc sizes:
  var keyString = key < 0 ? "\u266D" : "\u266F";
  var width = context.measureText(keyString).width;
  var totalWidth = Math.abs(key) * width;

  // Start with the first flat/sharp note:
  var note = key < 0 ? clef.flat_base : clef.sharp_base;

  // This is the step distance to the next fith or fourth:
  var increment = key > 0 ? 4 : 3;

  // Limit position to the octave around the first glyph and inside the stave
  // lines:
  var upperLimit = Math.min(note + 7, 9);
  var lowerLimit = Math.max(note - 7, -1);

  // Loop through keys:
  key = Math.abs(key);
  while (key > 0.5) {

    // Make sure that the glyph is inside the stave lines:
    while (note < lowerLimit)
      note += 7;
    while (note > upperLimit)
      note -= 7;

    // Draw the glyph:
    context.fillText(keyString, x, y - (textSize * Math.floor(note)) / 8);

    // Advance to next glyph:
    note += increment;
    key -= 1;
    x += width;
  }

  return totalWidth;
}


var clefs = [
  { clef: "G", trans: 2, octave: 0, shift: -2, flat_base: 4, sharp_base: 8 },
  { clef: "C", trans: 4, octave: 0, shift:  4 },
  { clef: "F", trans: 6, octave: 0, shift: 10 }
];
var cur_clef = 0;

////////////////////////////////////////////////////////////////////////////////
var canvas = document.getElementById("myCanvas");
var ctx = canvas.getContext('2d');//setupCanvas(canvas);
var textHeight = 80;
var base_x = 100.5;
var base_y = 200.5;
var width = 400;
var margin = textHeight / 4;

ctx.font = textHeight.toString() + 'px scoreGlyphs';
ctx.strokeStyle = "black";
ctx.fillStyle = "black";
ctx.lineWidth = 1;

var x = 0;
drawStaveLines(ctx, base_x, base_y, width, textHeight);

x += margin;
x += drawClef(ctx, clefs[cur_clef].clef, clefs[cur_clef].trans, clefs[cur_clef].octave, base_x + x, base_y, textHeight);

x += margin;
x += drawKey(ctx, -7, clefs[cur_clef], base_x + x, base_y, textHeight);

x += margin;
x += drawTimeSignature(ctx, 4, 4, true, base_x + x, base_y, textHeight);

</script>

</body>
</html>
